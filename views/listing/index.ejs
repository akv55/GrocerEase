<% layout("/layouts/boilerplate") -%>
    <div class="listing-card-container">
        <% for(let product of products){ %>
            <a href="/<%=product.slug%>" class="listing-link">
                <div class="listing-card">

                    <!-- Image Skeleton Loader -->
                    <div class="listing-image-container skeleton">
                        <img src="<%= product.image && product.image.url ? product.image.url : '/assets/img.jpg' %>"
                            class="listing-image" alt="<%= product.title %>" onload="removeSkeleton(this)" />
                    </div>

                    <form action="/wishlist/add/<%= product._id %>" method="POST" class="wishlist-form">
                        <button type="submit" class="wishlist-btn" title="Add to Wishlist">
                            <i class="fas fa-heart"></i>
                        </button>
                    </form>

                    <div class="listing-card-info">
                        <div class="listing-category">
                            <%= categories.find(cat=> cat._id.equals(product.category))?.name || 'Unknown' %>
                        </div>

                        <h3 class="listing-title">
                            <%= product.title %>
                        </h3>

                        <div class="rating">
                            <% 
                            const productRating = ratingsMap[product._id.toString()];
                            const rating = productRating ? productRating.average : 0;
                            const reviewCount = productRating ? productRating.count : 0;
                            %>
                            <div class="stars">
                                <% for(let i = 1; i <= 5; i++) { %>
                                    <% if(i <= Math.floor(rating)) { %>
                                        <i class="fas fa-star"></i>
                                    <% } else if(i === Math.ceil(rating) && rating % 1 !== 0) { %>
                                        <i class="fas fa-star-half-alt"></i>
                                    <% } else { %>
                                        <i class="far fa-star"></i>
                                    <% } %>
                                <% } %>
                            </div>
                            <span class="rating-count">
                                <% if(reviewCount > 0) { %>
                                    (<%= rating.toFixed(1) %>)
                                <% } else { %>
                                    (No reviews)
                                <% } %>
                            </span>
                        </div>

                        <div class="listing-details">
                            <div class="listing-quantity">
                                <%= product.weight.value || '' %>
                                    <%= product.weight.unit || '' %>
                            </div>
                            <div class="listing-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <%= product.location || 'Local' %>
                            </div>
                        </div>

                        <div class="listing-price">
                            <span class="currency">â‚¹</span>
                            <%= product.price ? product.price.toLocaleString("en-IN") : "0" %>
                        </div>
                    </div>
                </div>
            </a>
            <% } %>
    </div>
    <style>
        /* Skeleton effect */
        .skeleton {
            background: linear-gradient(90deg, #eee 25%, #ddd 50%, #eee 75%);
            background-size: 200% 100%;
            animation: shimmer 1.2s infinite;
        }

        @keyframes shimmer {
            from {
                background-position: 200% 0;
            }

            to {
                background-position: -200% 0;
            }
        }

        /* Image container */
        .listing-image-container {
            position: relative;
            width: 100%;
            height: 180px;
            overflow: hidden;
            border-radius: 8px;
        }

        /* Hide image until loaded */
        .listing-image,
        .show-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            transition: opacity 0.4s ease-in-out;
        }
    </style>
    <script>
        function removeSkeleton(img) {
            img.style.display = "block"; // Show image
            img.parentElement.classList.remove("skeleton"); // Remove skeleton shimmer
        }
    </script>